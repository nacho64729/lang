<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
  </head>

  <body>
    <!-- HEAD -->
    <div id="head-placeholder"></div>

    <!-- MAIN CONTENT -->
    <div class="box">
      <h1 id="page-title">Vocabulary Practice</h1>

      <div id="statusBar" style="margin-bottom:8px;">
        <span id="remainingLabel">Remaining: <span id="remainingCount">—</span></span>
      </div>

      <div id="wordBox">Word: <span id="currentWord"></span></div>
      <br />
      <input type="text" id="inputBox" placeholder="Enter your answer here..." />
      <button id="checkButton">Check</button>
      <button id="answerButton">Show Answer</button>
      <div id="message" style="margin-top:6px;"></div>
      <div id="solution" style="margin-top:4px; font-weight:bold;"></div>
    </div>

    <button id="saveChangesButton">Save progress</button>
    <br /><br />

    <!-- SCRIPT -->
    <script>
      async function includeHTML(file, elementId) {
        try {
          const response = await fetch(file);
          if (!response.ok) {
            throw new Error(`Error fetching ${file}: ${response.statusText}`);
          }
          const content = await response.text();
          document.getElementById(elementId).outerHTML = content;
        } catch (error) {
          console.error("Failed to load content:", error);
          document.getElementById(elementId).textContent = "Failed to load content.";
        }
      }

      includeHTML("partials/head.html", "head-placeholder");
      includeHTML("partials/nav.html", "nav-placeholder");

      // Page-specific configuration
      const pageConfig = {
        korean: {
          tsv: "dicts/korean_vocab.tsv",
          title: "한영 사전 연습",
          type_here: "여기 한글 입력하세요...",
        },
        chinese: {
          tsv: "dicts/chinese_vocab.tsv",
          title: "中英翻译实践",
          type_here: "在这里输入中文词汇",
        },
        hiragana_monographs: {
          tsv: "dicts/hiragana_monographs.tsv",
          title: "ひらがな五十音（発音区別符号付き）",
          type_here: "ここに入力..."
        },
        my_korean: {
          tsv: "dicts/my_korean.tsv",
          title: "my korean",
          type_here: "여기 한글 입력하세요..."
        }
      };

      const urlParams = new URLSearchParams(window.location.search);
      let lang = urlParams.get("lang") || "chinese"; // use let so we can reassign
      if (!pageConfig[lang]) {
        console.warn(`Invalid lang value: ${lang}. Falling back to default "chinese".`);
        lang = "chinese";
      }

      // Dynamic content updates
      document.getElementById("page-title").textContent = pageConfig[lang].title;
      document.getElementById("inputBox").placeholder = pageConfig[lang].type_here;

      // --- State ---
      let pairs = [];            // [{answer, hint, weight?}, ...]
      let order = [];            // shuffled array of indices to visit exactly once
      let currentIndex = null;   // current index in pairs
      let changes = {};          // { answer: +deltaWeight }
      let first_try = true;

      // Elements
      const wordBox = document.getElementById("currentWord");
      const messageElement = document.getElementById("message");
      const inputBox = document.getElementById("inputBox");
      const solutionElement = document.getElementById("solution");
      const remainingCountEl = document.getElementById("remainingCount");

      // Utilities
      function fisherYatesShuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
      }

      function updateRemainingCount() {
        remainingCountEl.textContent = order.length;
      }

      async function loadTSVFile() {
        try {
          const response = await fetch(pageConfig[lang].tsv);
          const tsvText = await response.text();

          const lines = tsvText
            .split("\n")
            .map(l => l.trim())
            .filter(Boolean);

          pairs = lines.map(line => {
            const cols = line.split("\t");
            const answer = (cols[0] ?? "").trim();
            const hint = (cols[1] ?? "").trim();
            const weight = cols[2] !== undefined ? Number(cols[2]) : 1;
            return { answer, hint, weight };
          });

          if (pairs.length === 0) {
            messageElement.textContent = "No words available!";
            messageElement.style.color = "red";
            return;
          }

          // Build a visit-once order and shuffle
          order = pairs.map((_, i) => i);
          fisherYatesShuffle(order);
          updateRemainingCount();

          // Start the first item
          nextPair();
        } catch (error) {
          console.error("Error loading the TSV file:", error);
          messageElement.textContent = "Error loading the word list. Please try again.";
          messageElement.style.color = "red";
        }
      }

      function nextPair() {
        solutionElement.textContent = ""; // clear shown answer
        if (order.length === 0) {
          // Finished every item exactly once
          wordBox.textContent = "";
          messageElement.textContent = "🎉 Done! You've gone through every word once.";
          messageElement.style.color = "green";
          updateRemainingCount();
          return;
        }

        currentIndex = order.shift(); // take next index once
        const currentPair = pairs[currentIndex];
        wordBox.textContent = currentPair.hint;
        messageElement.textContent = "";
        inputBox.value = "";
        first_try = true;

        updateRemainingCount();
      }

      function checkWord() {
        if (currentIndex === null) return;

        const currentPair = pairs[currentIndex];
        const userInput = inputBox.value.trim().toLowerCase();

        if (userInput === currentPair.answer.toLowerCase()) {
          messageElement.textContent = "Correct!";
          messageElement.style.color = "green";

          if (first_try) {
            // Track weight increment on first-try correct
            changes[currentPair.answer] = (changes[currentPair.answer] ?? 0) + 1;
          }

          first_try = true; // reset for next item
          setTimeout(() => {
            messageElement.textContent = "";
            nextPair();
          }, 600);
        } else {
          messageElement.textContent = "Incorrect! Try again.";
          messageElement.style.color = "red";
          first_try = false;
          // keep same item; do not advance
          setTimeout(() => { messageElement.textContent = ""; }, 800);
        }
      }

      function showAnswer() {
        if (currentIndex === null) return;
        solutionElement.textContent = pairs[currentIndex].answer;
        setTimeout(() => (solutionElement.textContent = ""), 3000);
      }

      function saveChanges() {
        // Merge changes into weights
        pairs.forEach(p => {
          if (changes[p.answer]) p.weight = (Number(p.weight) || 0) + changes[p.answer];
        });

        const updatedTSV = pairs
          .map(p => `${p.answer}\t${p.hint}\t${p.weight}`)
          .join("\n");

        // Option 1: POST to server (if you have an endpoint)
        fetch("/save-updated-tsv", {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: updatedTSV
        }).then(r => {
          if (r.ok) {
            alert("Changes saved successfully!");
          } else {
            alert("Failed to save changes.");
          }
        }).catch(() => {
          // swallow
        });

        // Option 2: Download locally
        const blob = new Blob([updatedTSV], { type: "text/plain" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "updated_vocab.tsv";
        link.click();
      }

      // Events
      document.getElementById("checkButton").addEventListener("click", checkWord);
      inputBox.addEventListener("keydown", (event) => {
        if (event.key === "Enter") checkWord();
      });
      document.getElementById("answerButton").addEventListener("click", showAnswer);
      document.getElementById("saveChangesButton").addEventListener("click", saveChanges);

      window.addEventListener("beforeunload", (event) => {
        if (Object.keys(changes).length > 0) {
          event.preventDefault();
          event.returnValue = "You have unsaved changes. Do you want to leave without saving?";
        }
      });

      loadTSVFile();
    </script>

    <!-- NAVIGATION BAR -->
    <div id="nav-placeholder"></div>
  </body>
</html>
